{{- if .Values.dashboards.enabled -}}
apiVersion: v1
kind: ConfigMap
metadata:
  name: {{ include "grafana.fullname" . }}-dashboards
  labels:
    {{- include "grafana.labels" . | nindent 4 }}
data:
  grafascope-overview.json: |
    {
      "uid": "grafascope-overview",
      "title": "Grafascope Overview",
      "schemaVersion": 39,
      "version": 1,
      "refresh": "30s",
      "time": { "from": "now-1h", "to": "now" },
      "panels": [
        {
          "id": 1,
          "type": "stat",
          "title": "VictoriaMetrics up",
          "description": "Prometheus up metric for the VictoriaMetrics scrape target (1 = up).",
          "datasource": { "type": "prometheus", "uid": "VictoriaMetrics" },
          "targets": [{ "expr": "up{job=\"victoria-metrics\"}", "refId": "A", "instant": true }],
          "options": { "colorMode": "background", "graphMode": "none", "justifyMode": "center" },
          "fieldConfig": {
            "defaults": {
              "mappings": [
                { "type": "value", "options": { "0": { "text": "DOWN" }, "1": { "text": "UP" } } }
              ],
              "thresholds": {
                "mode": "absolute",
                "steps": [
                  { "color": "red", "value": null },
                  { "color": "green", "value": 1 }
                ]
              }
            },
            "overrides": []
          },
          "gridPos": { "x": 0, "y": 0, "w": 6, "h": 6 }
        },
        {
          "id": 2,
          "type": "stat",
          "title": "VictoriaLogs up",
          "description": "Prometheus up metric for the VictoriaLogs scrape target (1 = up).",
          "datasource": { "type": "prometheus", "uid": "VictoriaMetrics" },
          "targets": [{ "expr": "up{job=\"victoria-logs\"}", "refId": "A", "instant": true }],
          "options": { "colorMode": "background", "graphMode": "none", "justifyMode": "center" },
          "fieldConfig": {
            "defaults": {
              "mappings": [
                { "type": "value", "options": { "0": { "text": "DOWN" }, "1": { "text": "UP" } } }
              ],
              "thresholds": {
                "mode": "absolute",
                "steps": [
                  { "color": "red", "value": null },
                  { "color": "green", "value": 1 }
                ]
              }
            },
            "overrides": []
          },
          "gridPos": { "x": 6, "y": 0, "w": 6, "h": 6 }
        },
        {
          "id": 3,
          "type": "stat",
          "title": "VictoriaTraces up",
          "description": "Prometheus up metric for the VictoriaTraces scrape target (1 = up).",
          "datasource": { "type": "prometheus", "uid": "VictoriaMetrics" },
          "targets": [{ "expr": "up{job=\"victoria-traces\"}", "refId": "A", "instant": true }],
          "options": { "colorMode": "background", "graphMode": "none", "justifyMode": "center" },
          "fieldConfig": {
            "defaults": {
              "mappings": [
                { "type": "value", "options": { "0": { "text": "DOWN" }, "1": { "text": "UP" } } }
              ],
              "thresholds": {
                "mode": "absolute",
                "steps": [
                  { "color": "red", "value": null },
                  { "color": "green", "value": 1 }
                ]
              }
            },
            "overrides": []
          },
          "gridPos": { "x": 12, "y": 0, "w": 6, "h": 6 }
        },
        {
          "id": 4,
          "type": "stat",
          "title": "Grafana up",
          "description": "Prometheus up metric for the Grafana scrape target (1 = up).",
          "datasource": { "type": "prometheus", "uid": "VictoriaMetrics" },
          "targets": [{ "expr": "up{job=\"grafana\"}", "refId": "A", "instant": true }],
          "options": { "colorMode": "background", "graphMode": "none", "justifyMode": "center" },
          "fieldConfig": {
            "defaults": {
              "mappings": [
                { "type": "value", "options": { "0": { "text": "DOWN" }, "1": { "text": "UP" } }
                }
              ],
              "thresholds": {
                "mode": "absolute",
                "steps": [
                  { "color": "red", "value": null },
                  { "color": "green", "value": 1 }
                ]
              }
            },
            "overrides": []
          },
          "gridPos": { "x": 18, "y": 0, "w": 6, "h": 6 }
        },
        {
          "id": 5,
          "type": "timeseries",
          "title": "VictoriaMetrics insert concurrency",
          "description": "Insert concurrency utilization (current / capacity).",
          "datasource": { "type": "prometheus", "uid": "VictoriaMetrics" },
          "targets": [
            {
              "expr": "vm_concurrent_insert_current{job=\"victoria-metrics\"} / vm_concurrent_insert_capacity{job=\"victoria-metrics\"}",
              "refId": "A",
              "legendFormat": "insert utilization"
            }
          ],
          "options": { "thresholdsStyle": { "mode": "area" }, "showThresholds": "on" },
          "fieldConfig": {
            "defaults": {
              "color": { "mode": "thresholds" },
              "min": 0,
              "max": 1,
              "custom": { "thresholdsStyle": { "mode": "area" } },
              "thresholds": {
                "mode": "absolute",
                "steps": [
                  { "color": "green", "value": 0 },
                  { "color": "yellow", "value": 0.7 },
                  { "color": "red", "value": 0.9 }
                ]
              }
            },
            "overrides": []
          },
          "gridPos": { "x": 0, "y": 14, "w": 8, "h": 8 }
        },
        {
          "id": 6,
          "type": "timeseries",
          "title": "VictoriaMetrics select concurrency",
          "description": "Query select concurrency utilization (current / capacity).",
          "datasource": { "type": "prometheus", "uid": "VictoriaMetrics" },
          "targets": [
            {
              "expr": "vm_concurrent_select_current{job=\"victoria-metrics\"} / vm_concurrent_select_capacity{job=\"victoria-metrics\"}",
              "refId": "A",
              "legendFormat": "select utilization"
            }
          ],
          "options": { "thresholdsStyle": { "mode": "area" }, "showThresholds": "on" },
          "fieldConfig": {
            "defaults": {
              "color": { "mode": "thresholds" },
              "min": 0,
              "max": 1,
              "custom": { "thresholdsStyle": { "mode": "area" } },
              "thresholds": {
                "mode": "absolute",
                "steps": [
                  { "color": "green", "value": 0 },
                  { "color": "yellow", "value": 0.7 },
                  { "color": "red", "value": 0.9 }
                ]
              }
            },
            "overrides": []
          },
          "gridPos": { "x": 0, "y": 38, "w": 8, "h": 8 }
        },
        {
          "id": 7,
          "type": "timeseries",
          "title": "VictoriaMetrics insert limits",
          "description": "Rate of insert limit reached events (throttling pressure).",
          "datasource": { "type": "prometheus", "uid": "VictoriaMetrics" },
          "targets": [
            {
              "expr": "rate(vm_concurrent_insert_limit_reached_total{job=\"victoria-metrics\"}[5m])",
              "refId": "A",
              "legendFormat": "limit reached /s"
            }
          ],
          "options": { "thresholdsStyle": { "mode": "area" }, "showThresholds": "on" },
          "fieldConfig": {
            "defaults": {
              "color": { "mode": "thresholds" },
              "min": 0,
              "max": 1,
              "custom": { "thresholdsStyle": { "mode": "area" } },
              "thresholds": {
                "mode": "absolute",
                "steps": [
                  { "color": "green", "value": 0 },
                  { "color": "yellow", "value": 0.1 },
                  { "color": "red", "value": 1 }
                ]
              }
            },
            "overrides": []
          },
          "gridPos": { "x": 16, "y": 14, "w": 8, "h": 8 }
        },
        {
          "id": 8,
          "type": "timeseries",
          "title": "VictoriaLogs select concurrency",
          "description": "Log select concurrency utilization (current / capacity).",
          "datasource": { "type": "prometheus", "uid": "VictoriaMetrics" },
          "targets": [
            {
              "expr": "vl_concurrent_select_current{job=\"victoria-logs\"} / vl_concurrent_select_capacity{job=\"victoria-logs\"}",
              "refId": "A",
              "legendFormat": "select utilization"
            }
          ],
          "options": { "thresholdsStyle": { "mode": "area" }, "showThresholds": "on" },
          "fieldConfig": {
            "defaults": {
              "color": { "mode": "thresholds" },
              "min": 0,
              "max": 1,
              "custom": { "thresholdsStyle": { "mode": "area" } },
              "thresholds": {
                "mode": "absolute",
                "steps": [
                  { "color": "green", "value": 0 },
                  { "color": "yellow", "value": 0.7 },
                  { "color": "red", "value": 0.9 }
                ]
              }
            },
            "overrides": []
          },
          "gridPos": { "x": 8, "y": 38, "w": 8, "h": 8 }
        },
        {
          "id": 9,
          "type": "timeseries",
          "title": "VictoriaLogs errors",
          "description": "Rate of VictoriaLogs HTTP errors.",
          "datasource": { "type": "prometheus", "uid": "VictoriaMetrics" },
          "targets": [
            {
              "expr": "sum(rate(vl_http_errors_total{job=\"victoria-logs\"}[5m]))",
              "refId": "A",
              "legendFormat": "errors /s"
            }
          ],
          "options": { "thresholdsStyle": { "mode": "area" }, "showThresholds": "on" },
          "fieldConfig": {
            "defaults": {
              "color": { "mode": "thresholds" },
              "min": 0,
              "max": 0.05,
              "custom": { "thresholdsStyle": { "mode": "area" } },
              "thresholds": {
                "mode": "absolute",
                "steps": [
                  { "color": "green", "value": 0 },
                  { "color": "yellow", "value": 0.01 },
                  { "color": "red", "value": 0.05 }
                ]
              }
            },
            "overrides": []
          },
          "gridPos": { "x": 8, "y": 14, "w": 8, "h": 8 }
        },
        {
          "id": 10,
          "type": "timeseries",
          "title": "VictoriaLogs dropped rows",
          "description": "Rate of dropped log rows during ingestion.",
          "datasource": { "type": "prometheus", "uid": "VictoriaMetrics" },
          "targets": [
            {
              "expr": "sum(rate(vl_rows_dropped_total{job=\"victoria-logs\"}[5m]))",
              "refId": "A",
              "legendFormat": "dropped /s"
            }
          ],
          "options": { "thresholdsStyle": { "mode": "area" }, "showThresholds": "on" },
          "fieldConfig": {
            "defaults": {
              "color": { "mode": "thresholds" },
              "min": 0,
              "max": 5,
              "custom": { "thresholdsStyle": { "mode": "area" } },
              "thresholds": {
                "mode": "absolute",
                "steps": [
                  { "color": "green", "value": 0 },
                  { "color": "yellow", "value": 1 },
                  { "color": "red", "value": 5 }
                ]
              }
            },
            "overrides": []
          },
          "gridPos": { "x": 16, "y": 22, "w": 8, "h": 8 }
        },
        {
          "id": 11,
          "type": "timeseries",
          "title": "VictoriaTraces select concurrency",
          "description": "Trace select concurrency utilization (current / capacity).",
          "datasource": { "type": "prometheus", "uid": "VictoriaMetrics" },
          "targets": [
            {
              "expr": "vt_concurrent_select_current{job=\"victoria-traces\"} / vt_concurrent_select_capacity{job=\"victoria-traces\"}",
              "refId": "A",
              "legendFormat": "select utilization"
            }
          ],
          "options": { "thresholdsStyle": { "mode": "area" }, "showThresholds": "on" },
          "fieldConfig": {
            "defaults": {
              "color": { "mode": "thresholds" },
              "min": 0,
              "max": 1,
              "custom": { "thresholdsStyle": { "mode": "area" } },
              "thresholds": {
                "mode": "absolute",
                "steps": [
                  { "color": "green", "value": 0 },
                  { "color": "yellow", "value": 0.7 },
                  { "color": "red", "value": 0.9 }
                ]
              }
            },
            "overrides": []
          },
          "gridPos": { "x": 16, "y": 38, "w": 8, "h": 8 }
        },
        {
          "id": 12,
          "type": "timeseries",
          "title": "VictoriaTraces errors",
          "description": "Rate of VictoriaTraces HTTP errors.",
          "datasource": { "type": "prometheus", "uid": "VictoriaMetrics" },
          "targets": [
            {
              "expr": "sum(rate(vt_http_errors_total{job=\"victoria-traces\"}[5m]))",
              "refId": "A",
              "legendFormat": "errors /s"
            }
          ],
          "options": { "thresholdsStyle": { "mode": "area" }, "showThresholds": "on" },
          "fieldConfig": {
            "defaults": {
              "color": { "mode": "thresholds" },
              "min": 0,
              "max": 0.05,
              "custom": { "thresholdsStyle": { "mode": "area" } },
              "thresholds": {
                "mode": "absolute",
                "steps": [
                  { "color": "green", "value": 0 },
                  { "color": "yellow", "value": 0.01 },
                  { "color": "red", "value": 0.05 }
                ]
              }
            },
            "overrides": []
          },
          "gridPos": { "x": 8, "y": 22, "w": 8, "h": 8 }
        },
        {
          "id": 13,
          "type": "timeseries",
          "title": "Grafana goroutines",
          "description": "Number of Go goroutines in Grafana process.",
          "datasource": { "type": "prometheus", "uid": "VictoriaMetrics" },
          "targets": [
            {
              "expr": "go_goroutines{job=\"grafana\"}",
              "refId": "A",
              "legendFormat": "goroutines"
            }
          ],
          "options": { "thresholdsStyle": { "mode": "area" }, "showThresholds": "on" },
          "fieldConfig": {
            "defaults": {
              "custom": { "thresholdsStyle": { "mode": "area" } },
              "thresholds": {
                "mode": "absolute",
                "steps": [
                  { "color": "green", "value": null },
                  { "color": "yellow", "value": 500 },
                  { "color": "red", "value": 1000 }
                ]
              }
            },
            "overrides": []
          },
          "gridPos": { "x": 0, "y": 22, "w": 8, "h": 8 }
        },
        {
          "id": 14,
          "type": "timeseries",
          "title": "Grafana heap alloc",
          "description": "Go heap allocated bytes for the Grafana process.",
          "datasource": { "type": "prometheus", "uid": "VictoriaMetrics" },
          "targets": [
            {
              "expr": "go_memstats_heap_alloc_bytes{job=\"grafana\"}",
              "refId": "A",
              "legendFormat": "heap bytes"
            }
          ],
          "options": { "thresholdsStyle": { "mode": "area" }, "showThresholds": "on" },
          "fieldConfig": {
            "defaults": {
              "unit": "bytes",
              "custom": { "thresholdsStyle": { "mode": "area" } },
              "thresholds": {
                "mode": "absolute",
                "steps": [
                  { "color": "green", "value": null },
                  { "color": "yellow", "value": 500000000 },
                  { "color": "red", "value": 1000000000 }
                ]
              }
            },
            "overrides": []
          },
          "gridPos": { "x": 0, "y": 30, "w": 8, "h": 8 }
        },
        {
          "id": 15,
          "type": "timeseries",
          "title": "Grafana access evaluation latency",
          "description": "Average access evaluation latency in seconds.",
          "datasource": { "type": "prometheus", "uid": "VictoriaMetrics" },
          "targets": [
            {
              "expr": "rate(grafana_access_evaluation_duration_sum{job=\"grafana\"}[5m]) / rate(grafana_access_evaluation_duration_count{job=\"grafana\"}[5m])",
              "refId": "A",
              "legendFormat": "avg seconds"
            }
          ],
          "options": { "thresholdsStyle": { "mode": "area" }, "showThresholds": "on" },
          "fieldConfig": {
            "defaults": {
              "custom": { "thresholdsStyle": { "mode": "area" } },
              "thresholds": {
                "mode": "absolute",
                "steps": [
                  { "color": "green", "value": null },
                  { "color": "yellow", "value": 0.05 },
                  { "color": "red", "value": 0.2 }
                ]
              }
            },
            "overrides": []
          },
          "gridPos": { "x": 8, "y": 30, "w": 8, "h": 8 }
        },
        {
          "id": 16,
          "type": "timeseries",
          "title": "VictoriaMetrics cache fill",
          "description": "Rollup result cache fill ratio (current / max).",
          "datasource": { "type": "prometheus", "uid": "VictoriaMetrics" },
          "targets": [
            {
              "expr": "vm_cache_size_bytes{job=\"victoria-metrics\",type=\"promql/rollupResult\"} / vm_cache_size_max_bytes{job=\"victoria-metrics\",type=\"promql/rollupResult\"}",
              "refId": "A",
              "legendFormat": "rollup cache fill"
            }
          ],
          "options": { "thresholdsStyle": { "mode": "area" }, "showThresholds": "on" },
          "fieldConfig": {
            "defaults": {
              "color": { "mode": "thresholds" },
              "min": 0,
              "max": 1,
              "custom": { "thresholdsStyle": { "mode": "area" } },
              "thresholds": {
                "mode": "absolute",
                "steps": [
                  { "color": "green", "value": 0 },
                  { "color": "yellow", "value": 0.7 },
                  { "color": "red", "value": 0.9 }
                ]
              }
            },
            "overrides": []
          },
          "gridPos": { "x": 16, "y": 30, "w": 8, "h": 8 }
        },
        {
          "id": 17,
          "type": "timeseries",
          "title": "Process memory",
          "description": "Resident memory per process.",
          "datasource": { "type": "prometheus", "uid": "VictoriaMetrics" },
          "targets": [
            {
              "expr": "process_resident_memory_bytes{job=~\"victoria-metrics|victoria-logs|victoria-traces|grafana\"}",
              "refId": "A",
              "legendFormat": "{{`{{job}}`}}"
            }
          ],
          "fieldConfig": {
            "defaults": {
              "unit": "decbytes"
            },
            "overrides": []
          },
          "gridPos": { "x": 0, "y": 6, "w": 12, "h": 8 }
        },
        {
          "id": 18,
          "type": "timeseries",
          "title": "Process CPU",
          "description": "CPU cores used per process (rate of CPU seconds).",
          "datasource": { "type": "prometheus", "uid": "VictoriaMetrics" },
          "targets": [
            {
              "expr": "rate(process_cpu_seconds_total{job=~\"victoria-metrics|victoria-logs|victoria-traces|grafana\"}[5m])",
              "refId": "A",
              "legendFormat": "{{`{{job}}`}}"
            }
          ],
          "fieldConfig": {
            "defaults": {
              "unit": "short"
            },
            "overrides": []
          },
          "gridPos": { "x": 12, "y": 6, "w": 12, "h": 8 }
        }
      ]
    }
  grafascope-scrape-targets.json: |
    {
      "uid": "grafascope-scrape-targets",
      "title": "Grafascope Scrape Targets",
      "schemaVersion": 39,
      "version": 1,
      "refresh": "30s",
      "time": { "from": "now-15m", "to": "now" },
      "panels": [
        {
          "id": 1,
          "type": "table",
          "title": "vmagent scrape targets",
          "description": "Target health from the vmagent scrape results (job + instance).",
          "datasource": { "type": "prometheus", "uid": "VictoriaMetrics" },
          "targets": [
            {
              "expr": "up",
              "refId": "A",
              "instant": true,
              "format": "table"
            }
          ],
          "transformations": [
            {
              "id": "organize",
              "options": {
                "includeByName": { "instance": true, "Value": true },
                "renameByName": { "Value": "status" }
              }
            }
          ],
          "fieldConfig": {
            "defaults": {
              "color": { "mode": "thresholds" },
              "mappings": [
                { "type": "value", "options": { "0": { "text": "DOWN" }, "1": { "text": "UP" } } }
              ],
              "thresholds": {
                "mode": "absolute",
                "steps": [
                  { "color": "red", "value": null },
                  { "color": "green", "value": 1 }
                ]
              }
            },
            "overrides": [
              {
                "matcher": { "id": "byName", "options": "status" },
                "properties": [
                  { "id": "custom.displayMode", "value": "color-background" },
                  { "id": "custom.cellOptions", "value": { "type": "color-background" } },
                  { "id": "color", "value": { "mode": "thresholds" } },
                  { "id": "thresholds", "value": { "mode": "absolute", "steps": [ { "color": "red", "value": null }, { "color": "green", "value": 1 } ] } },
                  { "id": "mappings", "value": [ { "type": "value", "options": { "0": { "text": "DOWN" }, "1": { "text": "UP" } } } ] }
                ]
              }
            ]
          },
          "options": { "showHeader": true },
          "gridPos": { "x": 0, "y": 0, "w": 24, "h": 12 }
        }
      ]
    }
{{- end }}

